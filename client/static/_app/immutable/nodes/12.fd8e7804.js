import{S as te,i as re,s as se,k as O,a as W,q as oe,y as Z,l as A,m as C,h as k,c as H,r as ae,z as x,n as h,b as ne,L as T,W as V,A as $,G as J,g as B,f as ie,d as P,ak as le,B as ee,P as ce,H as U,o as j,af as ue,v as me,w as fe}from"../chunks/index.7bf39313.js";import{M as pe}from"../chunks/message.21c9d164.js";import{n as ge,p as de}from"../chunks/stores.da986137.js";import{g as z,c as he,P as _e}from"../chunks/pocketbase.c6bc3d05.js";import{R as q,c as be}from"../chunks/constant.407e1c3c.js";import{c as N,m as R,p as Se,a as ye,r as Te}from"../chunks/store.f4ca8b1d.js";import{M as w,C as G}from"../chunks/types.88dddc30.js";import{I as ve}from"../chunks/icon.75f33e0e.js";import{g as X}from"../chunks/util.8bfa846c.js";function Q(r,i,s){const t=r.slice();return t[19]=i[s],t[21]=s,t}function Y(r){let i,s;return i=new pe({props:{avatar:X(G.User,r[19].sender.id,r[19].sender.avatar),name:r[19].sender.username,timestamp:r[19].created,message:r[19].content.toString(),self:r[19].sender.username==r[3]?.username}}),{c(){Z(i.$$.fragment)},l(t){x(i.$$.fragment,t)},m(t,m){$(i,t,m),s=!0},p(t,m){const c={};m&4&&(c.avatar=X(G.User,t[19].sender.id,t[19].sender.avatar)),m&4&&(c.name=t[19].sender.username),m&4&&(c.timestamp=t[19].created),m&4&&(c.message=t[19].content.toString()),m&12&&(c.self=t[19].sender.username==t[3]?.username),i.$set(c)},i(t){s||(B(i.$$.fragment,t),s=!0)},o(t){P(i.$$.fragment,t),s=!1},d(t){ee(i,t)}}}function ke(r){let i,s,t,m,c,_,v,E,f,u,p,g,S,b,M,I,y=r[2],a=[];for(let o=0;o<y.length;o+=1)a[o]=Y(Q(r,y,o));const D=o=>P(a[o],1,1,()=>{a[o]=null});return g=new ve({props:{name:"paper-airplane",width:"16px",height:"16px"}}),{c(){i=O("div"),s=O("section");for(let o=0;o<a.length;o+=1)a[o].c();t=W(),m=O("section"),c=O("div"),_=O("button"),v=oe("+"),E=W(),f=O("textarea"),u=W(),p=O("button"),Z(g.$$.fragment),this.h()},l(o){i=A(o,"DIV",{class:!0});var l=C(i);s=A(l,"SECTION",{class:!0});var e=C(s);for(let L=0;L<a.length;L+=1)a[L].l(e);e.forEach(k),t=H(l),m=A(l,"SECTION",{class:!0});var n=C(m);c=A(n,"DIV",{class:!0});var d=C(c);_=A(d,"BUTTON",{class:!0});var F=C(_);v=ae(F,"+"),F.forEach(k),E=H(d),f=A(d,"TEXTAREA",{class:!0,name:!0,id:!0,placeholder:!0,rows:!0}),C(f).forEach(k),u=H(d),p=A(d,"BUTTON",{class:!0});var K=C(p);x(g.$$.fragment,K),K.forEach(k),d.forEach(k),n.forEach(k),l.forEach(k),this.h()},h(){h(s,"class","p-4 overflow-y-auto space-y-4"),h(_,"class","input-group-shim"),h(f,"class","bg-transparent border-0 ring-0"),h(f,"name","prompt"),h(f,"id","prompt"),h(f,"placeholder","Write a message..."),h(f,"rows","1"),h(p,"class",S=r[1]?"variant-filled-primary":"input-group-shim"),h(c,"class","input-group input-group-divider grid-cols-[auto_1fr_auto] rounded-container-token"),h(m,"class","border-t border-surface-500/30 p-4"),h(i,"class","flex flex-col flex-nowrap justify-end max-h-screen")},m(o,l){ne(o,i,l),T(i,s);for(let e=0;e<a.length;e+=1)a[e]&&a[e].m(s,null);r[11](s),T(i,t),T(i,m),T(m,c),T(c,_),T(_,v),T(c,E),T(c,f),V(f,r[1]),T(c,u),T(c,p),$(g,p,null),b=!0,M||(I=[J(f,"input",r[12]),J(f,"keydown",r[5]),J(p,"click",r[4])],M=!0)},p(o,[l]){if(l&12){y=o[2];let e;for(e=0;e<y.length;e+=1){const n=Q(o,y,e);a[e]?(a[e].p(n,l),B(a[e],1)):(a[e]=Y(n),a[e].c(),B(a[e],1),a[e].m(s,null))}for(me(),e=y.length;e<a.length;e+=1)D(e);ie()}l&2&&V(f,o[1]),(!b||l&2&&S!==(S=o[1]?"variant-filled-primary":"input-group-shim"))&&h(p,"class",S)},i(o){if(!b){for(let l=0;l<y.length;l+=1)B(a[l]);B(g.$$.fragment,o),b=!0}},o(o){a=a.filter(Boolean);for(let l=0;l<a.length;l+=1)P(a[l]);P(g.$$.fragment,o),b=!1},d(o){o&&k(i),le(a,o),r[11](null),ee(g),M=!1,ce(I)}}}function we(r,i,s){let t,m,c,_,v,E,f;U(r,Te,e=>s(15,c=e)),U(r,N,e=>s(8,_=e)),U(r,ge,e=>s(9,v=e)),U(r,de,e=>s(10,E=e)),U(r,he,e=>s(3,f=e));let u,p,g=[],S="",b;const M=()=>{if(!v)return!1;const{from:e,to:n}=v;return!e?.params||!n?.params||!e.route||!n.route||e.params.roomSlug==n.params.roomSlug||e.route.id!=n.route.id?!1:u?(u.send(JSON.stringify({content:"",from:e.params.roomSlug,to:n.params.roomSlug,messageType:w.Swap})),N.set(n.params.roomSlug),!0):!1};N.subscribe(()=>{});const I=()=>{u||(u=new WebSocket(`${_e}${q}/${_}`))};j(()=>{I(),u&&(u.onopen=e=>{console.log("It's open")},u.onmessage=e=>{const n=JSON.parse(e.data);switch(n.messageType){case w.Swap:break;case w.Text:R.set(n);break;case w.Welcome:R.set(n);break;case w.Bailout:R.set(n);break;case w.Ping:console.log({ping:n}),Array.isArray(n.content)&&Se.update(d=>({...d,data:n.content}));break;case w.History:s(6,g=[]),Array.isArray(n.content)&&n.content.forEach(d=>R.set(d));break;default:R.set(n);break}},u.onerror=async e=>{console.log("err")},u.onclose=e=>{console.log("closed"),b&&clearTimeout(b),b=setTimeout(async()=>{await ye(),c.data.find(d=>d.slug===t)||z(q+"/"+be)},1e3)})}),ue(()=>{u&&u.close(),b&&clearTimeout(b)});const y=()=>{u&&u.readyState<=1&&u.send(JSON.stringify({content:S,messageType:w.Text})),s(1,S="")};R.subscribe(e=>{e&&(s(6,g=[...g,e]),R.set(null),setTimeout(()=>{a("smooth")},0))});function a(e){p&&p.scrollTo({top:p.scrollHeight,behavior:e})}function D(e){["Enter"].includes(e.code)&&(e.preventDefault(),y())}j(()=>{a()});function o(e){fe[e?"unshift":"push"](()=>{p=e,s(0,p)})}function l(){S=this.value,s(1,S)}return r.$$.update=()=>{r.$$.dirty&1024&&s(7,t=E.url.searchParams.get("slug")),r.$$.dirty&128&&(t||z(q)),r.$$.dirty&384&&t&&t!==_&&N.set(t),r.$$.dirty&512&&v&&(M(),setTimeout(()=>{a("smooth")},0)),r.$$.dirty&192&&s(2,m=g.filter(e=>e.roomSlug==t))},[p,S,m,f,y,D,g,t,_,v,E,o,l]}class Ne extends te{constructor(i){super(),re(this,i,we,ke,se,{})}}export{Ne as component};
