import{S as ee,i as te,s as re,k as w,a as W,q as se,y as Y,l as E,m as O,h as T,c as H,r as oe,z as Z,n as p,b as ae,L as S,W as K,A as $,G as J,g as I,f as ne,d as P,ak as ie,B as x,P as le,H as B,o as V,af as ce,v as ue,w as me}from"../chunks/index.7bf39313.js";import{M as fe}from"../chunks/message.21c9d164.js";import{p as pe,n as ge}from"../chunks/stores.da986137.js";import{g as de,c as he,P as _e}from"../chunks/pocketbase.c6bc3d05.js";import{R as j,c as be}from"../chunks/constant.407e1c3c.js";import{c as N,m as A,p as Se,a as ye,r as Te}from"../chunks/store.f4ca8b1d.js";import{M as v,C as z}from"../chunks/types.88dddc30.js";import{I as ve}from"../chunks/icon.75f33e0e.js";import{g as G}from"../chunks/util.8bfa846c.js";function X(r,l,o){const a=r.slice();return a[18]=l[o],a[20]=o,a}function Q(r){let l,o;return l=new fe({props:{avatar:G(z.User,r[18].sender.id,r[18].sender.avatar),name:r[18].sender.username,timestamp:r[18].created,message:r[18].content.toString(),self:r[18].sender.username==r[3]?.username}}),{c(){Y(l.$$.fragment)},l(a){Z(l.$$.fragment,a)},m(a,c){$(l,a,c),o=!0},p(a,c){const u={};c&4&&(u.avatar=G(z.User,a[18].sender.id,a[18].sender.avatar)),c&4&&(u.name=a[18].sender.username),c&4&&(u.timestamp=a[18].created),c&4&&(u.message=a[18].content.toString()),c&12&&(u.self=a[18].sender.username==a[3]?.username),l.$set(u)},i(a){o||(I(l.$$.fragment,a),o=!0)},o(a){P(l.$$.fragment,a),o=!1},d(a){x(l,a)}}}function ke(r){let l,o,a,c,u,g,y,C,n,_,m,f,b,k,M,U,d=r[2],i=[];for(let s=0;s<d.length;s+=1)i[s]=Q(X(r,d,s));const D=s=>P(i[s],1,1,()=>{i[s]=null});return f=new ve({props:{name:"paper-airplane",width:"16px",height:"16px"}}),{c(){l=w("div"),o=w("section");for(let s=0;s<i.length;s+=1)i[s].c();a=W(),c=w("section"),u=w("div"),g=w("button"),y=se("+"),C=W(),n=w("textarea"),_=W(),m=w("button"),Y(f.$$.fragment),this.h()},l(s){l=E(s,"DIV",{class:!0});var e=O(l);o=E(e,"SECTION",{class:!0});var t=O(o);for(let L=0;L<i.length;L+=1)i[L].l(t);t.forEach(T),a=H(e),c=E(e,"SECTION",{class:!0});var h=O(c);u=E(h,"DIV",{class:!0});var R=O(u);g=E(R,"BUTTON",{class:!0});var q=O(g);y=oe(q,"+"),q.forEach(T),C=H(R),n=E(R,"TEXTAREA",{class:!0,name:!0,id:!0,placeholder:!0,rows:!0}),O(n).forEach(T),_=H(R),m=E(R,"BUTTON",{class:!0});var F=O(m);Z(f.$$.fragment,F),F.forEach(T),R.forEach(T),h.forEach(T),e.forEach(T),this.h()},h(){p(o,"class","p-4 overflow-y-auto space-y-4"),p(g,"class","input-group-shim"),p(n,"class","bg-transparent border-0 ring-0"),p(n,"name","prompt"),p(n,"id","prompt"),p(n,"placeholder","Write a message..."),p(n,"rows","1"),p(m,"class",b=r[1]?"variant-filled-primary":"input-group-shim"),p(u,"class","input-group input-group-divider grid-cols-[auto_1fr_auto] rounded-container-token"),p(c,"class","border-t border-surface-500/30 p-4"),p(l,"class","flex flex-col flex-nowrap justify-end max-h-screen")},m(s,e){ae(s,l,e),S(l,o);for(let t=0;t<i.length;t+=1)i[t]&&i[t].m(o,null);r[10](o),S(l,a),S(l,c),S(c,u),S(u,g),S(g,y),S(u,C),S(u,n),K(n,r[1]),S(u,_),S(u,m),$(f,m,null),k=!0,M||(U=[J(n,"input",r[11]),J(n,"keydown",r[5]),J(m,"click",r[4])],M=!0)},p(s,[e]){if(e&12){d=s[2];let t;for(t=0;t<d.length;t+=1){const h=X(s,d,t);i[t]?(i[t].p(h,e),I(i[t],1)):(i[t]=Q(h),i[t].c(),I(i[t],1),i[t].m(o,null))}for(ue(),t=d.length;t<i.length;t+=1)D(t);ne()}e&2&&K(n,s[1]),(!k||e&2&&b!==(b=s[1]?"variant-filled-primary":"input-group-shim"))&&p(m,"class",b)},i(s){if(!k){for(let e=0;e<d.length;e+=1)I(i[e]);I(f.$$.fragment,s),k=!0}},o(s){i=i.filter(Boolean);for(let e=0;e<i.length;e+=1)P(i[e]);P(f.$$.fragment,s),k=!1},d(s){s&&T(l),ie(i,s),r[10](null),x(f),M=!1,le(U)}}}function we(r,l,o){let a,c,u,g,y,C;B(r,pe,e=>o(7,c=e)),B(r,Te,e=>o(14,u=e)),B(r,N,e=>o(8,g=e)),B(r,ge,e=>o(9,y=e)),B(r,he,e=>o(3,C=e));let n,_,m=[],f="",b;const k=()=>{if(!y)return!1;const{from:e,to:t}=y;return!e?.params||!t?.params||!e.route||!t.route||e.params.roomSlug==t.params.roomSlug||e.route.id!=t.route.id?!1:n?(n.send(JSON.stringify({content:"",from:e.params.roomSlug,to:t.params.roomSlug,messageType:v.Swap})),N.set(t.params.roomSlug),!0):!1};N.subscribe(()=>{});const M=()=>{n||(n=new WebSocket(`${_e}${j}/${g}`))};V(()=>{M(),n&&(n.onopen=e=>{console.log("It's open")},n.onmessage=e=>{const t=JSON.parse(e.data);switch(t.messageType){case v.Swap:break;case v.Text:A.set(t);break;case v.Welcome:A.set(t);break;case v.Bailout:A.set(t);break;case v.Ping:console.log({ping:t}),Array.isArray(t.content)&&Se.update(h=>({...h,data:t.content}));break;case v.History:o(6,m=[]),Array.isArray(t.content)&&t.content.forEach(h=>A.set(h));break;default:A.set(t);break}},n.onerror=async e=>{console.log("err")},n.onclose=e=>{console.log("closed"),b&&clearTimeout(b),b=setTimeout(async()=>{await ye(),u.data.find(h=>h.slug===c.params.roomSlug)||de(j+"/"+be)},1e3)})}),ce(()=>{n&&n.close(),b&&clearTimeout(b)});const U=()=>{n&&n.readyState<=1&&n.send(JSON.stringify({content:f,messageType:v.Text})),o(1,f="")};A.subscribe(e=>{e&&(o(6,m=[...m,e]),A.set(null),setTimeout(()=>{d("smooth")},0))});function d(e){_&&_.scrollTo({top:_.scrollHeight,behavior:e})}function i(e){["Enter"].includes(e.code)&&(e.preventDefault(),U())}V(()=>{d()});function D(e){me[e?"unshift":"push"](()=>{_=e,o(0,_)})}function s(){f=this.value,o(1,f)}return r.$$.update=()=>{r.$$.dirty&384&&c.params.roomSlug!==g&&N.set(c.params.roomSlug),r.$$.dirty&512&&y&&(k(),setTimeout(()=>{d("smooth")},0)),r.$$.dirty&192&&o(2,a=m.filter(e=>e.roomSlug==c.params.roomSlug))},[_,f,a,C,U,i,m,c,g,y,D,s]}class Ne extends ee{constructor(l){super(),te(this,l,we,ke,re,{})}}export{Ne as component};
